<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URLç”¨æˆ·ä¿¡æ¯æµ‹è¯•</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .info-box {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .button {
            background: var(--tg-theme-button-color, #007bff);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” URLç”¨æˆ·ä¿¡æ¯æµ‹è¯•</h1>
        
        <div class="info-box">
            <h3>ğŸ“‹ æµ‹è¯•è¯´æ˜</h3>
            <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•ä»URLå‚æ•°è·å–ç”¨æˆ·ä¿¡æ¯çš„åŠŸèƒ½ã€‚</p>
            <p>è¯·åœ¨URLä¸­æ·»åŠ ä»¥ä¸‹å‚æ•°ï¼š</p>
            <ul>
                <li><code>user_id</code> - ç”¨æˆ·IDï¼ˆå¿…éœ€ï¼‰</li>
                <li><code>username</code> - ç”¨æˆ·åï¼ˆå¯é€‰ï¼‰</li>
                <li><code>first_name</code> - åå­—ï¼ˆå¿…éœ€ï¼‰</li>
                <li><code>last_name</code> - å§“æ°ï¼ˆå¯é€‰ï¼‰</li>
                <li><code>language_code</code> - è¯­è¨€ä»£ç ï¼ˆå¯é€‰ï¼‰</li>
                <li><code>page</code> - é¡µé¢ç±»å‹ï¼ˆå¯é€‰ï¼‰</li>
            </ul>
        </div>
        
        <div class="info-box">
            <h3>ğŸ”— ç¤ºä¾‹URL</h3>
            <h4>åŸºæœ¬ç”¨æˆ·ä¿¡æ¯æµ‹è¯•:</h4>
            <pre>test-url-user-info.html?user_id=1939818627&username=testuser&first_name=Test&last_name=User&language_code=zh</pre>
            
            <h4>ç›´æ¥æ‰“å¼€è®¢å•é¡µé¢:</h4>
            <pre>supermarket.html?user_id=1939818627&first_name=Test&last_name=User&tab=orders</pre>
            
            <h4>æ”¯æŒçš„tabå‚æ•°å€¼:</h4>
            <ul>
                <li><code>tab=products</code> æˆ– <code>page=order</code> - å•†å“é¡µé¢</li>
                <li><code>tab=cart</code> æˆ– <code>page=shopping_cart</code> - è´­ç‰©è½¦é¡µé¢</li>
                <li><code>tab=orders</code> æˆ– <code>page=my_orders</code> - è®¢å•é¡µé¢</li>
            </ul>
        </div>
        
        <div class="info-box">
            <h3>ğŸŒ å½“å‰URL</h3>
            <pre id="current-url"></pre>
        </div>
        
        <div class="info-box">
            <h3>ğŸ“± Telegram API ä¿¡æ¯</h3>
            <pre id="telegram-info"></pre>
        </div>
        
        <div class="info-box">
            <h3>ğŸ”— URLå‚æ•°ä¿¡æ¯</h3>
            <pre id="url-info"></pre>
        </div>
        
        <div class="info-box">
            <h3>âœ… æœ€ç»ˆç”¨æˆ·ä¿¡æ¯</h3>
            <pre id="final-info"></pre>
        </div>
        
        <div>
            <button class="button" onclick="refreshInfo()">ğŸ”„ åˆ·æ–°ä¿¡æ¯</button>
            <button class="button" onclick="testWithSampleData()">ğŸ“ ä½¿ç”¨ç¤ºä¾‹æ•°æ®æµ‹è¯•</button>
            <button class="button" onclick="clearUrl()">ğŸ—‘ï¸ æ¸…ç©ºURLå‚æ•°</button>
        </div>
        
        <div class="info-box">
            <h3>ğŸ§ª å¿«é€Ÿæµ‹è¯•é“¾æ¥</h3>
            <div>
                <button class="button" onclick="testOrdersTab()">ğŸ“‹ æµ‹è¯•è®¢å•é¡µé¢</button>
                <button class="button" onclick="testCartTab()">ğŸ›’ æµ‹è¯•è´­ç‰©è½¦é¡µé¢</button>
                <button class="button" onclick="testProductsTab()">ğŸ›ï¸ æµ‹è¯•å•†å“é¡µé¢</button>
            </div>
        </div>
    </div>
    
    <script>
        // å¤åˆ¶supermarket.htmlä¸­çš„ç”¨æˆ·ä¿¡æ¯è·å–å‡½æ•°
        
        /**
         * éªŒè¯ç”¨æˆ·ä¿¡æ¯çš„å®Œæ•´æ€§
         */
        function validateUserInfo(userInfo) {
            if (!userInfo) {
                return false;
            }
            
            // åŸºæœ¬éªŒè¯
            if (!userInfo.id || !userInfo.first_name) {
                return false;
            }
            
            // éªŒè¯IDæ˜¯å¦ä¸ºæœ‰æ•ˆæ•°å­—
            if (isNaN(userInfo.id) || userInfo.id <= 0) {
                return false;
            }
            
            // éªŒè¯åå­—é•¿åº¦
            if (userInfo.first_name.length === 0 || userInfo.first_name.length > 64) {
                return false;
            }
            
            return true;
        }

        /**
         * ä»URLå‚æ•°è·å–ç”¨æˆ·ä¿¡æ¯
         */
        function getUserInfoFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            
            const userInfo = {
                id: urlParams.get('user_id'),
                username: urlParams.get('username'),
                first_name: urlParams.get('first_name') ? decodeURIComponent(urlParams.get('first_name')) : '',
                last_name: urlParams.get('last_name') ? decodeURIComponent(urlParams.get('last_name')) : '',
                language_code: urlParams.get('language_code') || '',
                page: urlParams.get('page') || 'order'
            };
            
            // éªŒè¯å¿…è¦ä¿¡æ¯
            if (!userInfo.id) {
                return null;
            }
            
            // è½¬æ¢IDä¸ºæ•°å­—ç±»å‹
            userInfo.id = parseInt(userInfo.id);
            
            // éªŒè¯ç”¨æˆ·ä¿¡æ¯å®Œæ•´æ€§
            if (!validateUserInfo(userInfo)) {
                console.warn('âš ï¸ [getUserInfoFromUrl] URLå‚æ•°ä¸­çš„ç”¨æˆ·ä¿¡æ¯ä¸å®Œæ•´æˆ–æ— æ•ˆ:', userInfo);
                return null;
            }
            
            console.log('ğŸ”— [getUserInfoFromUrl] ä»URLè·å–åˆ°ç”¨æˆ·ä¿¡æ¯:', userInfo);
            return userInfo;
        }

        /**
         * ä» Telegram API è·å–ç”¨æˆ·ä¿¡æ¯
         */
        function getTelegramUserInfo() {
            // é¦–å…ˆå°è¯•ä» Telegram API è·å–ç”¨æˆ·ä¿¡æ¯
            if (typeof Telegram !== 'undefined' && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {
                const user = Telegram.WebApp.initDataUnsafe.user;
                const userInfo = {
                    id: user.id,
                    username: user.username,
                    first_name: user.first_name,
                    last_name: user.last_name,
                    language_code: user.language_code,
                    is_premium: user.is_premium,
                    allows_write_to_pm: user.allows_write_to_pm
                };
                console.log('ğŸ“± [getTelegramUserInfo] ä»Telegram APIè·å–åˆ°ç”¨æˆ·ä¿¡æ¯:', userInfo);
                return userInfo;
            }
            
            // å¦‚æœæ— æ³•ä» Telegram API è·å–ï¼Œå°è¯•ä»URLå‚æ•°è·å–
            const urlUserInfo = getUserInfoFromUrl();
            if (urlUserInfo) {
                console.log('ğŸ”— [getTelegramUserInfo] å›é€€åˆ°URLå‚æ•°è·å–ç”¨æˆ·ä¿¡æ¯:', urlUserInfo);
                return urlUserInfo;
            }
            
            console.log('âŒ [getTelegramUserInfo] æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯');
            return null;
        }
        
        /**
         * åˆ·æ–°ä¿¡æ¯æ˜¾ç¤º
         */
        function refreshInfo() {
            // å½“å‰URL
            document.getElementById('current-url').textContent = window.location.href;
            
            // Telegram API ä¿¡æ¯
            const telegramInfo = (typeof Telegram !== 'undefined' && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) 
                ? Telegram.WebApp.initDataUnsafe.user : null;
            document.getElementById('telegram-info').innerHTML = telegramInfo 
                ? `<span class="success">âœ… å¯ç”¨</span>\n${JSON.stringify(telegramInfo, null, 2)}`
                : `<span class="error">âŒ ä¸å¯ç”¨</span>`;
            
            // URLå‚æ•°ä¿¡æ¯
            const urlInfo = getUserInfoFromUrl();
            document.getElementById('url-info').innerHTML = urlInfo 
                ? `<span class="success">âœ… å¯ç”¨</span>\n${JSON.stringify(urlInfo, null, 2)}`
                : `<span class="error">âŒ ä¸å¯ç”¨</span>`;
            
            // æœ€ç»ˆç”¨æˆ·ä¿¡æ¯
            const finalInfo = getTelegramUserInfo();
            document.getElementById('final-info').innerHTML = finalInfo 
                ? `<span class="success">âœ… è·å–æˆåŠŸ</span>\n${JSON.stringify(finalInfo, null, 2)}`
                : `<span class="error">âŒ è·å–å¤±è´¥</span>`;
        }
        
        /**
         * ä½¿ç”¨ç¤ºä¾‹æ•°æ®æµ‹è¯•
         */
        function testWithSampleData() {
            const sampleParams = 'user_id=1939818627&username=testuser&first_name=Test&last_name=User&language_code=zh&page=order';
            const newUrl = window.location.pathname + '?' + sampleParams;
            window.location.href = newUrl;
        }
        
        /**
         * æ¸…ç©ºURLå‚æ•°
         */
        function clearUrl() {
            window.location.href = window.location.pathname;
        }
        
        /**
         * æµ‹è¯•è®¢å•é¡µé¢
         */
        function testOrdersTab() {
            const params = 'user_id=1939818627&first_name=Test&last_name=User&tab=orders';
            const newUrl = '../supermarket.html?' + params;
            window.open(newUrl, '_blank');
        }
        
        /**
         * æµ‹è¯•è´­ç‰©è½¦é¡µé¢
         */
        function testCartTab() {
            const params = 'user_id=1939818627&first_name=Test&last_name=User&tab=cart';
            const newUrl = '../supermarket.html?' + params;
            window.open(newUrl, '_blank');
        }
        
        /**
         * æµ‹è¯•å•†å“é¡µé¢
         */
        function testProductsTab() {
            const params = 'user_id=1939818627&first_name=Test&last_name=User&tab=products';
            const newUrl = '../supermarket.html?' + params;
            window.open(newUrl, '_blank');
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            // ç¡®ä¿ Telegram WebApp å®Œå…¨åŠ è½½
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
            }
            
            // åˆ·æ–°ä¿¡æ¯æ˜¾ç¤º
            refreshInfo();
        });
    </script>
</body>
</html> 